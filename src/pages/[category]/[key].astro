---
import PrintFooter from "../../components/PrintFooter.astro";
import assets from "../../assets.json";
import BaseLayout from "../../layouts/BaseLayout.astro";

/** @param {string} categoryParam */
function getCategoryObjectKey(categoryParam) {
  // Find the object key matching the categoryParam (which may be a title_key)
  for (const [objectKey, cat] of Object.entries(assets)) {
    if (objectKey === categoryParam) return objectKey;
    if (cat.title_key === categoryParam) return objectKey;
  }
  return categoryParam;
}

/** Generate static paths for all images in all categories */
export async function getStaticPaths() {
  const paths = [];
  for (const [catKey, cat] of Object.entries(assets)) {
    for (const item of cat.items) {
      paths.push({
        params: { category: catKey, key: item.key },
        props: {
          image: item,
          category: catKey,
          catTitle: cat.title_key ?? catKey,
        },
      });
    }
  }
  return paths;
}

/** @typedef {{ key: string; file: string; description?: string; width?: number; height?: number }} ImageItem */
/** @typedef {{ title_key?: string; description?: string; header?: string; items: ImageItem[] }} Category */
/** @type {Record<string, Category>} */
const assetsMap = /** @type {any} */ (assets);
/** @type {{ category: string; key: string; image: ImageItem }} */
const { category, key, image } = Astro.props;

const objectKey = getCategoryObjectKey(category);
const cat = assetsMap[objectKey];
const catTitle = cat.title_key;
const catDescription = cat.description ?? "";
const title = image.key
  .replace(/_/g, " ")
  .replace(/\b\w/g, /** @param {string} l */ (l) => l.toUpperCase());
const description =
  image?.description ?? `Kolorowanka z kategorii ${catTitle}: ${title}`;
const year = new Date().getFullYear();
---

<BaseLayout
  title={title}
  description={description}
  bodyClass="bg-base-100"
  showSidebar={true}
>
  <div
    id="print-area"
    class="w-full max-w-2xl flex flex-col items-center bg-base-100"
  >
    <img
      src={`/${image.file}`}
      alt={image.description ?? title}
      id="main-image"
      class="max-w-full max-h-[80vh] mb-6"
      width={image.width ?? 800}
      height={image.height ?? 600}
      title={image.description ?? title}
    />
    <PrintFooter />
  </div>
  <button
    onclick="window.print()"
    class="no-print btn btn-outline btn-primary btn-sm mb-8 w-auto self-center"
  >
    Drukuj obrazek
  </button>
  <a
    href={`/${objectKey}/`}
    class="no-print text-primary hover:underline"
    title={catDescription}
    aria-label={`Powrót do kategorii ${catTitle}: ${catDescription}`}
  >
    Powrót do kategorii: {catTitle}
  </a>
</BaseLayout>
