---
import "../../styles.css";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import PrintFooter from "../../components/PrintFooter.astro";
import assets from "../../assets.json";
import Head from "../../components/Head.astro";
import Sidebar from "../../components/Sidebar.astro";

function getCategoryObjectKey(categoryParam) {
  // Find the object key matching the categoryParam (which may be a title_key)
  for (const [objectKey, cat] of Object.entries(assets)) {
    if (objectKey === categoryParam) return objectKey;
    if (cat.title_key === categoryParam) return objectKey;
  }
  return categoryParam;
}

/** Generate static paths for all images in all categories */
export async function getStaticPaths() {
  const paths = [];
  for (const [catKey, cat] of Object.entries(assets)) {
    for (const item of cat.items) {
      paths.push({
        params: { category: catKey, key: item.key },
        props: {
          image: item,
          category: catKey,
          catTitle: cat.title_key ?? catKey,
        },
      });
    }
  }
  return paths;
}

const { category, key } = Astro.props;
const { image } = Astro.props;
const objectKey = getCategoryObjectKey(category);
const cat = assets[objectKey];
const catTitle = cat.title_key;
const title = image.key
  .replace(/_/g, " ")
  .replace(/\b\w/g, (l) => l.toUpperCase());
const year = new Date().getFullYear();
---

<html lang="en">
  <Head title={title} />
  <body class="text-default bg-base-200 flex flex-col min-h-screen">
    <Navbar />
    <div class="flex flex-row flex-1 w-full">
      <Sidebar />
      <main
        class="flex flex-col items-center justify-center bg-base-200 flex-1"
      >
        <div
          id="print-area"
          class="w-full max-w-2xl flex flex-col items-center bg-base-200"
        >
          <img
            src={`/${image.file}`}
            alt={title}
            id="main-image"
            class="max-w-full max-h-[80vh] mb-6"
          />
          <button
            onclick="printArea()"
            class="no-print btn btn-outline btn-primary btn-sm mb-8"
          >
            Drukuj obrazek
          </button>
          <a
            href={`/${objectKey}/`}
            class="no-print text-blue-600 hover:underline"
          >
            Powr√≥t do kategorii {catTitle}
          </a>
        </div>
      </main>
    </div>
    <Footer />
    <PrintFooter />
    <script is:inline>
      function printArea() {
        const printContents = document.getElementById("print-area").innerHTML;
        const printWindow = window.open("", "", "height=800,width=600");
        printWindow.document.write("<html><head><title>Drukuj obrazek</title>");
        // Copy stylesheets
        document
          .querySelectorAll('link[rel="stylesheet"], style')
          .forEach((styleNode) => {
            printWindow.document.write(styleNode.outerHTML);
          });
        printWindow.document.write("</head><body>");
        printWindow.document.write(printContents);
        printWindow.document.write("</body></html>");
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
      }
    </script>
    <script is:inline>
      function printArea() {
        document.body.classList.add("print-area-only");
        window.print();
        document.body.classList.remove("print-area-only");
      }
    </script>
  </body>
</html>
