---
import BaseLayout from "../layouts/BaseLayout.astro";
import assets from "../assets.json";
import IndexTemplate from "../templates/IndexTemplate.astro";

const contentFiles = import.meta.glob('../content/kolorowanki/*.json', { eager: true });

function getRandomItem(arr) {
  if (!arr || arr.length === 0) return null;
  return arr[Math.floor(Math.random() * arr.length)];
}

const items = Object.entries(contentFiles).map(([path, contentModule]) => {
  const content = contentModule.default;
  const categoryKey = path.split('/').pop().replace('.json', '');
  const assetCategory = assets[categoryKey];

  if (!assetCategory || !assetCategory.items || assetCategory.items.length === 0) {
    return null; // Skip category if no assets
  }
  
  const randomAssetItem = getRandomItem(assetCategory.items);
  if (!randomAssetItem) return null;

  const randomImageContent = content.images.find(img => img.key === randomAssetItem.key);

  // If a matching image content is not found, skip this item
  if (!randomImageContent) {
    return null;
  }

  return {
    href: `/${content.category_slug}/`,
    imgSrc: `/${randomAssetItem.file}`,
    imgAlt: randomImageContent.title,
    title: content.category_title,
    buttonText: content.category_title,
  };
}).filter(Boolean); // Remove null entries
---

<BaseLayout title="Kolorowanki dla wszystkich" bodyClass="bg-base-200">
  <main class="flex-1 flex flex-col pt-0 bg-base-200 min-h-0">
    <IndexTemplate
      items={items}
      headerImgSrc="/assets/header.webp"
      headerImgAlt="Zamaluj.pl"
      headerDescription="Darmowe kolorowanki do druku dla dzieci i dorosłych. Znajdziesz tu setki wzorów: zwierzęta, pojazdy, bajki, święta, Minecraft i wiele innych. Pobieraj, drukuj i rozwijaj kreatywność każdego dnia."
    />
  </main>
  <script>
    window.addEventListener("analyticsLoaded", ({ detail: trackEvent }) => {
      trackEvent();
    });
  </script>
</BaseLayout>
