---
import BaseLayout from "../../layouts/BaseLayout.astro";
import assets from "../../assets.json";
import { getPageData } from "../../utils/imagePageHelpers.js";

export async function getStaticPaths() {
  const contentFiles = import.meta.glob("../../content/kolorowanki/*.json");
  const paths = [];
  for (const path in contentFiles) {
    const categoryModule = await contentFiles[path]();
    const categoryContent = categoryModule.default;
    const categoryKey = path.split("/").pop().replace(".json", "");

    for (const image of categoryContent.images) {
      paths.push({
        params: {
          category_slug: categoryContent.category_slug,
          slug: image.slug,
        },
        props: {
          image,
          categoryKey,
          categoryTitle: categoryContent.category_title,
          categoryDescription: categoryContent.category_description,
          categoryImages: categoryContent.images,
        },
      });
    }
  }
  return paths;
}

const { image, categoryKey, categoryTitle, categoryDescription, categoryImages } = Astro.props;

const { description, pageTitle, seeAlsoImages } = getPageData(image, categoryKey, categoryTitle, categoryImages);

const assetItem = assets[categoryKey]?.items.find(
  (item) => item.key === image.key,
);

if (!assetItem) {
  return new Response(null, { status: 404 });
}

const title = pageTitle;

// Schema.org for Google Images
const schema = {
  "@context": "https://schema.org",
  "@type": "ImageObject",
  "name": title,
  "description": description,
  "contentUrl": new URL(assetItem.webp_large, Astro.site).href,
  "thumbnailUrl": new URL(assetItem.webp_thumb, Astro.site).href,
  "width": 1200,
  "height": 1697,
  "license": new URL('/polityka-prywatnosci', Astro.site).href,
  "author": {
    "@type": "Organization",
    "name": "Zamaluj.pl"
  }
};
---

<BaseLayout
  title={title}
  description={description}
  bodyClass="bg-base-100"
  showSidebar={true}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  <nav class="text-sm breadcrumbs w-full px-2 sm:px-4 mt-4">
    <ul class="justify-start">
      <li><a href="/">Zamaluj.pl</a></li>
      <li><a href={`/${Astro.params.category_slug}/`}>{categoryTitle}</a></li>
      <li>{image.title}</li>
    </ul>
  </nav>
  <h1 class="text-3xl sm:text-4xl font-bold tracking-tight mt-4 mb-4 text-base-content text-center px-2 sm:px-4">
    {pageTitle}
  </h1>
  <div
    class="w-full max-w-2xl flex flex-col items-center bg-base-100 px-2 sm:px-4 pt-4 sm:pt-6 mt-2 sm:mt-4"
  >
    <img
      src={`/${assetItem.webp_large}`}
      alt={title}
      id="main-image"
      class="w-full h-auto max-w-full object-contain mb-4 md:mb-6 min-h-0"
      srcset={`/${assetItem.webp_thumb} 350w, /${assetItem.webp_large} 1200w`}
      sizes="(max-width: 600px) 350px, 1200px"
      width={1200}
      height={1697}
      title={title}
      loading="eager"
      decoding="async"
    />
  </div>
  <div
    class="no-print flex flex-col gap-3 items-center justify-center mt-2 mb-6 md:mb-8 w-full max-w-2xl px-2 sm:px-4"
  >
    <button
      onclick={`printPdf(this, '/${assetItem.pdf_file}')`}
      class="btn btn-primary btn-md md:btn-sm w-full sm:w-auto px-6"
    >
      Drukuj obrazek
    </button>
    {
      description && (
        <div class="prose max-w-none text-base sm:text-lg leading-relaxed text-base-content/80 mt-4 text-center px-4 sm:px-0">
          <p>{description}</p>
        </div>
      )
    }
    <a
      href={`/${Astro.params.category_slug}/`}
      class="text-primary hover:underline w-full sm:w-auto text-center sm:text-left mt-4"
      title={categoryDescription}
      aria-label={`Powrót do kategorii ${categoryTitle}`}
    >
      Powrót do kategorii: {categoryTitle}
    </a>
  </div>
  {
    seeAlsoImages.length > 0 && (
      <div class="flex flex-col items-center justify-center mt-8 w-full max-w-2xl px-2 sm:px-4">
        <h2 class="text-2xl font-bold mb-4">Zobacz Także</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full">
          {seeAlsoImages.map((img) => (
            <a href={`/${Astro.params.category_slug}/${img.slug}/`} class="block">
              <img
                src={`/assets/${categoryKey}/${img.key}-350.webp`}
                alt={img.title}
                class="w-full h-auto object-cover rounded-lg shadow-md"
                loading="lazy"
                decoding="async"
              />
              <p class="text-sm text-center mt-2">{img.title}</p>
            </a>
          ))}
        </div>
      </div>
    )
  }
  <script is:inline>
    function printPdf(button, pdfUrl) {
      // Disable button and show spinner
      button.disabled = true;
      const originalContent = button.innerHTML;
      button.innerHTML = '<span class="loading loading-spinner"></span> Czekaj...';

      const printFrame = document.createElement('iframe');
      printFrame.style.display = 'none';
      printFrame.src = pdfUrl;
      document.body.appendChild(printFrame);

      // Give the PDF time to load, then try to print.
      setTimeout(function() {
        try {
          printFrame.contentWindow.focus();
          printFrame.contentWindow.print();
        } catch (e) {
          console.error("Failed to print PDF via iframe:", e);
          // Fallback for browsers that block cross-frame printing
          alert("Nie udało się automatycznie otworzyć okna drukowania. PDF otworzy się w nowej karcie, gdzie można go wydrukować ręcznie.");
          window.open(pdfUrl, '_blank');
        } finally {
          // Restore button state immediately so the user can try again if needed.
          button.disabled = false;
          button.innerHTML = originalContent;
        }
        // NOTE: The iframe is intentionally NOT removed. It stays hidden and will be
        // gone on the next page navigation, but it must persist for the print dialog.
      }, 1000);
    }

    window.addEventListener("analyticsLoaded", ({ detail: trackEvent }) => {
      trackEvent();
    });
  </script>
</BaseLayout>